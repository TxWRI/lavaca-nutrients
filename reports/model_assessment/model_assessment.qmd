---
title: "Supporting Materials: GAM Model Assessment"
author: 
  - name: Michael Schramm
    affiliations:
      - name: Texas A\&M AgriLife Research
        department: Texas Water Resources Institute
    orcid: 0000-0003-1876-6592
    email: michael.schramm@ag.tamu.edu
abstract: |
  This document includes model summaries and diagnostics for each Nitrate-Nitrogen (NO~3~-N) and Total Phosphorus (TP) Generalized Additive Model (GAM) developed in the Lavaca River Watershed.
thanks: |
  This project was funded by a Texas Coastal Management Program grant approved by the Texas Land Commissioner, providing financial assistance under the Coastal Zone Management Act of 1972, as amended, awarded by the National Oceanic and Atmospheric Administration (NOAA), Office for Coastal Management, pursuant to NOAA Award No. NA21NOS4190136. The views expressed herein are those of the author(s) and do not necessarily reflect the views of NOAA, the U.S. Department of Commerce, or any of their subagencies.
format: 
  pdf:
    keep-md: true
    keep-tex: true
    documentclass: article
    mainfont: MINIONPRO-REGULAR.OTF
    sansfont: MORISTONPERSONAL-REGULAR.OTF
    number-sections: true
    fig-pos: 'h'
    execute:
      eval: true
      echo: false
      warning: false
      error: false
      message: false
    include-in-header:
      text: |
        \usepackage{flafter, amsmath, booktabs, caption, longtable, changepage, multirow}
        \newenvironment{widestuff}{\begin{table}[h]\begin{adjustwidth}{-4.5cm}{-4.5cm}\centering}{\end{adjustwidth}\end{table}}
knitr: 
  opts_chunk: 
    dev: ragg_png
    dpi: 200
    # flextable options
    ft.align: "center"
    ft.latex.float: "none"
    #ft.tabcolsep: 0
    tab.lp: "tbl-"
bibliography: reference.yml
csl: https://raw.githubusercontent.com/TxWRI/csl/main/twri-technical-report.csl
---

# Modeling Approach

Site-specific Generalized Additive Models (GAMs) were developed for Nitrate-Nitrogen (NO~3~-N) and Total Phosphorus (TP). Previous papers suggest that other regression based load estimators, namely Weighted Regressions on Time Discharge and Season (WRTDS) produce results similar to GAMs where flow and season are primary drivers in nutrient loads [@beckNumericalQualitativeContrasts2017]. However, the mgcv package used to implement GAMs are easily extended to additional predictor variables and therefore chosen to be applied here [@beckNumericalQualitativeContrasts2017; @robsonPredictionSedimentParticulate2015a; @kuhnertQuantifyingTotalSuspended2012]. 

A suite of potential flow-based predictor variables were developed based on [@zhangImprovingRiverineConstituent2017].

$$
Y = s(ddate) + s(yday) + s(log1p(Q)) + s(stfa) + s(ma)
$$

where $Y$ is the response variable that is a function of the sum of some smoothed predictor variables. For each of the stream sites the response variable is daily NO~3~-N or TP load in kg/day. 

 - $ddate$ is date converted to decimal format;
 - $yday$ is the day of the year as a numeral between 1 and 366;
 - $log1p(Q)$ is mean daily streamflow plus one, log transformed;
 - $stfa$ is a short-term flow anomaly, a unitless term that reflects the difference in the current discharge from flows in the previous month;
 - $ma$ is the exponentially smoothed flow which is used to incorporate the influence of past flows on current load or concentration estimates;

The model was slightly altered for the Lake Texana site where daily load measurements are not a function of natural flow processes, but of operation decisions. Here, we expect concentration to vary as a function of tributary inputs and some unknown lake metabolism processes. At this location, daily concentrations were modeled as a function of total inflow to the lake. Each of the flow based covariates ($log1p(Q)$, $stfa$, and $ma$) were calculated based on total inflow from gaged tributaries. Total loads below Palmetto Bend Dam are then estimated using nutrient concentration in Lake Texana and reported mean daily dam discharges.

Thin plate regression splines were used for $ddate$, $log1p(Q)$, $ltfa$, and $ma$. A cyclic cubic regression spline was used for $yday$ to ensure ends of the spline match (day 1 and day 366 should match). First-order penalties were applied to the smooths of flow-based variables which penalize departures from a flat function to help constrain extrapolations for high flow measurements. GAMs were fit using the `gam()` function in the "mgcv" package in R version 4.2.1. Basis dimensions used for smooths were adjusted after using the `gam.check()` function to ensure models were not oversmoothed. Model residuals were inspected for distributional assumptions using the "gratia" package.

Left-censored nutrient concentrations were not uncommon in this dataset. Several methods are available to account for censored data. We decided to transform left-censored data to one-half the detection limit based on the fact that higher concentrations and loadings are typically associated with high-flow events and low-flow/low-concentration events will account for a small proportion of total loadings [@mcdowellImplicationsLagTimes2021]. The "cenGAM" package in R provides the Tobit I family to accommodate censored data using the "gam" function in R. Censored Gamma models can be fit using a Bayesian framework with the "brms" package in R. Initial exploration using "cenGAM" and "brms" packages resulted in models that overestimated nutrient concentrations relative to "mgcv" [@bergbuschUnexpectedShiftPhytoplankton2021]. All models were fit using the Gamma family and log link function.

Hold-out data is often used to validate predictive ability of a model. Given the small-sample size, we used all the available data to fit models at each site and implemented repeated 10-fold cross validation to assess model performance. Cross-validation predictions were assessed using King-Glupta Efficiency (KGE), R^2^, and Percent Bias across all folds.

# Model Results

## Lavaca River at Edna, 08164000 

```{r}
#| echo: false
#| message: false
library(targets)
library(mgcv)
library(gratia)
library(twriTemplates)
library(patchwork)
library(tidyverse)
library(ggtext)
library(flextable)
library(adc)
library(scico)
library(gt)
```

### NO~3~-N


```{r}
#| echo: false

tar_read(summary_no3_08164000)

```



```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of NO~3~-N GAM at Lavaca River at Edna, USGS-08164000."
#| label: tbl-NO308164000-CV

tar_read(cv_no3_08164000) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()

```


\clearpage


```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for NO~3~-N model at USGS-08164000"
#| fig-width: 6
#| fig-height: 6
gratia::appraise(tar_read(no3_08164000), 
                 method = "simulate") & theme_TWRI_print()
```

```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in NO~3~-N model at USGS-08164000"
#| fig-width: 6.5
#| fig-height: 7
gratia::draw(tar_read(no3_08164000), 
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) & 
  theme_TWRI_print() & 
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_no3_08164000)
```


```{r}
#| echo: false
#| fig-cap: "Time series plot of NO~3~-N model predictions and observed values at USGS-08164000"
gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164000",
                            Date >= as.Date("2005-01-01")),
                   model = tar_read(no3_08164000), value = ".fits",
                   type = "response") |>
  mutate(censored_NO3 = case_when(
    is.na(censored_NO3) ~ "Measured NO<sub>3</sub>-N",
    !is.na(censored_NO3) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, NO3_flux, color = censored_NO3), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "NO<sub>3</sub>-N [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank(),
        legend.text = element_markdown())
```


\clearpage


### TP


```{r}
#| echo: false

tar_read(summary_tp_08164000)

```


```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of TP load GAM at Lavaca River at Edna, USGS-08164000."
#| label: tbl-TP308164000-CV

tar_read(cv_tp_08164000) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for TP model at USGS-08164000"
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(tp_08164000), method = "simulate") & theme_TWRI_print()
```

```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in TP model at USGS-08164000"
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(tp_08164000),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_tp_08164000)
```

```{r}
#| echo: false
#| fig-cap: "Time series plot of TP model predictions and observed values at USGS-08164000"

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164000"),
                   model = tar_read(tp_08164000), value = ".fits",
                   type = "response") |>
    mutate(censored_TP = case_when(
    is.na(censored_TP) ~ "Measured TP",
    !is.na(censored_TP) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, TP_flux, color = censored_TP), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "TP [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank())
```



\clearpage

## Navidad River at Strane Pk nr Edna, 08164390

### NO~3~



```{r}
#| echo: false

tar_read(summary_no3_08164390)

```


```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of NO~3~-N concentration GAM at Navidad River at Strane Pk nr Edna,, USGS-NO308164390."
#| label: tbl-NO308164390-CV

tar_read(cv_no3_08164390) |>
  ungroup() |>
  dplyr::select(-c(data, id)) |>
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |>
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |>
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for NO~3~ model at USGS-08164390."
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(no3_08164390), method = "simulate") & theme_TWRI_print()
```



```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in NO~3~-N model at USGS-08164390."
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(no3_08164390),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_no3_08164390)
```

```{r}
#| echo: false
#| fig-cap: "Time series plot of NO~3~ model predictions and observed values at USGS-08164390."

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164390",
                            Date >= as.Date("2005-01-01")),
                   model = tar_read(no3_08164390), value = ".fits",
                   type = "response") |>
  mutate(censored_NO3 = case_when(
    is.na(censored_NO3) ~ "Measured NO<sub>3</sub>-N",
    !is.na(censored_NO3) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, NO3_flux, color = censored_NO3), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "NO<sub>3</sub>-N [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank(),
        legend.text = element_markdown())
```

\clearpage

### TP



```{r}
#| echo: false

tar_read(summary_tp_08164390)

```


```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of TP load GAM at Navidad River at Strane Pk nr Edna, USGS-08164390."
#| label: tbl-TP08164390-CV

tar_read(cv_tp_08164390) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for TP model at USGS-08164390."
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(tp_08164390), method = "simulate") & theme_TWRI_print()
```


```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in TP model at USGS-08164390."
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(tp_08164390),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_tp_08164390)
```


```{r}
#| echo: false
#| fig-cap: "Time series plot of TP model predictions and observed values at USGS-08164390."

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164390",),
                   model = tar_read(tp_08164390), value = ".fits",
                   type = "response") |>
    mutate(censored_TP = case_when(
    is.na(censored_TP) ~ "Measured TP",
    !is.na(censored_TP) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, TP_flux, color = censored_TP), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "TP [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank())
```

\clearpage


## Sandy Creek nr Ganado, USGS-08164450

### NO~3~



```{r}
#| echo: false

tar_read(summary_no3_08164450)

```

```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of NO~3~-N concentration GAM at Sandy Creek nr Ganado, USGS-08164450."
#| label: tbl-NO308164450-CV

tar_read(cv_no3_08164450) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for NO~3~ model at USGS-08164450."
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(no3_08164450), method = "simulate") & theme_TWRI_print()
```



```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in NO~3~-N model at USGS-08164450."
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(no3_08164450),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```


```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_no3_08164450)
```


```{r}
#| echo: false
#| fig-cap: "Time series plot of NO~3~ model predictions and observed values at USGS-08164450."

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164450",
                            Date >= as.Date("2005-01-01")),
                   model = tar_read(no3_08164450), value = ".fits",
                   type = "response") |>
  mutate(censored_NO3 = case_when(
    is.na(censored_NO3) ~ "Measured NO<sub>3</sub>-N",
    !is.na(censored_NO3) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, NO3_flux, color = censored_NO3), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "NO<sub>3</sub>-N [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank(),
        legend.text = element_markdown())
```

\clearpage


### TP


```{r}
#| echo: false

tar_read(summary_tp_08164450)
```


```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of TP load GAM at Sandy Creek nr Ganado, USGS-08164450."
#| label: tbl-TP08164450-CV

tar_read(cv_tp_08164450) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for TP model at USGS-08164450."
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(tp_08164450), method = "simulate") & theme_TWRI_print()
```


```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in TP model at USGS-08164450."
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(tp_08164450),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_tp_08164450)
```


```{r}
#| echo: false
#| fig-cap: "Time series plot of TP model predictions and observed values at USGS-08164450."

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164450",),
                   model = tar_read(tp_08164450), value = ".fits",
                   type = "response") |>
    mutate(censored_TP = case_when(
    is.na(censored_TP) ~ "Measured TP",
    !is.na(censored_TP) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, TP_flux, color = censored_TP), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "TP [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank())
```

\clearpage


## E Mustang Creek nr Louise, USGS-08164504

### NO~3~



```{r}
#| echo: false
#| 
tar_read(summary_no3_08164504)
```

```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of NO~3~-N load GAM at E Mustang Creek nr Louise, USGS-08164504."
#| label: tbl-NO308164504-CV

tar_read(cv_no3_08164504) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for NO~3~ model at USGS-08164504"
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(no3_08164504), method = "simulate") & theme_TWRI_print()
```



```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in NO~3~-N model at USGS-08164504"
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(no3_08164504),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_no3_08164504)
```

```{r}
#| echo: false
#| fig-cap: "Time series plot of NO~3~ model predictions and observed values at USGS-08164504"

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164504",
                            Date >= as.Date("2005-01-01")),
                   model = tar_read(no3_08164504), value = ".fits",
                   type = "response") |>
  mutate(censored_NO3 = case_when(
    is.na(censored_NO3) ~ "Measured NO<sub>3</sub>-N",
    !is.na(censored_NO3) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, NO3_flux, color = censored_NO3), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "NO<sub>3</sub>-N [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank(),
        legend.text = element_markdown())
```


\clearpage

### TP



```{r}
#| echo: false

tar_read(summary_tp_08164504)

```


```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of TP load GAM at E Mustang Creek nr Louise, USGS-08164504."
#| label: tbl-TP08164504-CV

tar_read(cv_tp_08164504) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```


\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for TP model at USGS-08164504"
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(tp_08164504), method = "simulate") & theme_TWRI_print()
```


```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in TP model at USGS-08164504"
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(tp_08164504),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_tp_08164504)
```


```{r}
#| echo: false
#| fig-cap: "Time series plot of TP model predictions and observed values at USGS-08164504"

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164504",),
                   model = tar_read(tp_08164504), value = ".fits",
                   type = "response") |>
    mutate(censored_TP = case_when(
    is.na(censored_TP) ~ "Measured TP",
    !is.na(censored_TP) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, TP_flux, color = censored_TP), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "TP [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank())
```

\clearpage

## W Mustang Creek nr Ganado, USGS-08164503

### NO~3~



```{r}
#| echo: false


tar_read(summary_no3_08164503)

```

```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of NO~3~-N load GAM at W Mustang Creek nr Ganado, USGS-08164503."
#| label: tbl-NO08164503-CV

tar_read(cv_no3_08164503) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for NO~3~ model at USGS-08164503"
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(no3_08164503), method = "simulate") & theme_TWRI_print()
```



```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in NO~3~-N model at USGS-08164503"
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(no3_08164503),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```

```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_no3_08164503)
```

```{r}
#| echo: false
#| fig-cap: "Time series plot of NO~3~ model predictions and observed values at USGS-08164503"

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164503",
                            Date >= as.Date("2005-01-01")),
                   model = tar_read(no3_08164503), value = ".fits",
                   type = "response") |>
  mutate(censored_NO3 = case_when(
    is.na(censored_NO3) ~ "Measured NO<sub>3</sub>-N",
    !is.na(censored_NO3) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, NO3_flux, color = censored_NO3), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "NO<sub>3</sub>-N [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank(),
        legend.text = element_markdown())
```


\clearpage

### TP



```{r}
#| echo: false

tar_read(summary_tp_08164503)
```

```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of TP load GAM at W Mustang Creek nr Ganado, USGS-08164503."
#| label: tbl-TP08164503-CV

tar_read(cv_tp_08164503) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for TP model at USGS-08164503"
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(tp_08164503), method = "simulate") & theme_TWRI_print()
```


```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in TP model at USGS-08164503"
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(tp_08164503),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```


```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily discharge and (b) predicted daily fluxes (for both sampled and non-sampled days) and measured daily fluxes."

tar_read(bias_plot_tp_08164503)
```

```{r}
#| echo: false
#| fig-cap: "Time series plot of TP model predictions and observed values at USGS-08164503"

gratia::add_fitted(tar_read(model_data) |>
                     filter(site_no == "usgs08164503",),
                   model = tar_read(tp_08164503), value = ".fits",
                   type = "response") |>
    mutate(censored_TP = case_when(
    is.na(censored_TP) ~ "Measured TP",
    !is.na(censored_TP) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, TP_flux, color = censored_TP), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "TP [kg/day]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank())
```

\clearpage


## Palmetto Bend Dam


### NO~3~



```{r}
#| echo: false

tar_read(summary_no3_texana)
```


```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of NO~3~-N load GAM at Palmetto Bend Dam."
#| label: tbl-NO3PalmettoBend-CV

tar_read(cv_no3_texana) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for NO~3~ model below Palmetto Bend Dam."
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(no3_texana), method = "simulate") & theme_TWRI_print()
```



```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in NO~3~-N model below Palmetto Bend Dam."
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(no3_texana),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```


```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily inflows and (b) predicted daily concentration (for both sampled and non-sampled days) and measured daily concentration."

tar_read(bias_plot_no3_texana)
```

```{r}
#| echo: false
#| fig-cap: "Time series plot of NO~3~ model predictions and observed values below Palmetto Bend Dam."

format_dam_data <- function(data) {
  gaged_inflow <- data |>
    filter(site_no != "lktexana_g") |>
    filter(site_no != "usgs08164000") |>
    select(c(Date, site_no, Flow)) |>
    pivot_wider(names_from = site_no,
                values_from = Flow) |>
    mutate(inflow = usgs08164390 + usgs08164450 + usgs08164503 + usgs08164504)

  below_tex <- data |>
    filter(site_no == "lktexana_g") |>
    mutate(inflow = gaged_inflow$inflow) |>
    mutate(# flow anomalies
      ltfa = fa(inflow+1, Date, T_1 = "1 year",
                T_2 = "period", transform = "log"),
      stfa = fa(inflow+1, Date, T_1 = "1 day",
                T_2 = "1 month", transform = "log"),
      # smooth discounted flow
      ma = sdf(log1p(inflow)))
  return(below_tex)
}

data <- format_dam_data(targets::tar_read(model_data)) |>
  filter(Date >= as.Date("2005-01-01"))

gratia::add_fitted(data = data,
                   model = tar_read(no3_texana),
                   value = ".fits",
                   type = "response") |>
    mutate(censored_NO3 = case_when(
    is.na(censored_NO3) ~ "Measured NO<sub>3</sub>-N",
    !is.na(censored_NO3) ~ "Censored Value"
  )) |> 
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, NO3, color = censored_NO3), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "NO<sub>3</sub> [mg/L]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank(),
        legend.text = element_markdown())

```

\clearpage

### TP



```{r}
#| echo: false

tar_read(summary_tp_texana)

```


```{r}
#| echo: false
#| tbl-cap: "Summary of goodness-of-fit metrics for 10-fold cross-validation of TP GAM at Palmetto Bend Dam."
#| label: tbl-TPPalmettoBend-CV

tar_read(cv_tp_texana) |> 
  ungroup() |> 
  dplyr::select(-c(data, id)) |> 
  gtsummary::tbl_summary(
    label = list(kge ~ "KGE",
                 r2 ~ "R^2^",
                 pbias ~ "Percent Bias"),
    type = list(pbias ~ "continuous")
  ) |> 
  gtsummary::modify_header(label = "**Goodness of Fit Metric**",
                           gtsummary::all_stat_cols() ~ "**Median (IQR)**") |> 
  gtsummary::as_kable()
```

\clearpage

```{r}
#| echo: false
#| fig-cap: "Diagnostic plot for TP model below Palmetto Bend Dam."
#| fig-width: 6
#| fig-height: 6

gratia::appraise(tar_read(tp_texana), method = "simulate") & theme_TWRI_print()
```



```{r}
#| echo: false
#| fig-cap: "Partial effects of covariates in TP model below Palmetto Bend Dam."
#| fig-width: 6.5
#| fig-height: 7

gratia::draw(tar_read(tp_texana),
             residuals = TRUE,
             dist = 0.25,
             continuous_fill = scico::scale_fill_scico(palette = "vik")
             ) &
  theme_TWRI_print() &
  theme(legend.position = "right")
```


```{r}
#| echo: false
#| fig-cap: "Comparisons of (a) in-sample and out-of-sample mean daily inflows and (b) predicted daily concentration (for both sampled and non-sampled days) and measured daily concentration."

tar_read(bias_plot_tp_texana)
```

```{r}
#| echo: false
#| fig-cap: "Time series plot of TP model predictions and observed values below Palmetto Bend Dam."


data <- format_dam_data(targets::tar_read(model_data)) |>
  filter(Date >= as.Date("2000-01-01"))

gratia::add_fitted(data = data,
                   model = tar_read(tp_texana),
                   value = ".fits",
                   type = "response") |>
    mutate(censored_TP = case_when(
    is.na(censored_TP) ~ "Measured TP",
    !is.na(censored_TP) ~ "Censored Value"
  )) |>
  ggplot() +
  geom_line(aes(Date, .fits, linetype = "Model Predictions"), alpha = 0.5) +
  geom_point(aes(Date, TP, color = censored_TP), alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  labs(y = "TP [mg/L]", x = "Date") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        legend.title = element_blank(),
        legend.text = element_markdown())

```


\clearpage






## References