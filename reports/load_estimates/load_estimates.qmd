---
title: "Supporting Materials: Load Estimates"
author: 
  - name: Michael Schramm
    affiliations:
      - name: Texas A\&M AgriLife Research
        department: Texas Water Resources Institute
    orcid: 0000-0003-1876-6592
    email: michael.schramm@ag.tamu.edu
abstract: |
  This document includes figures and tables summarizing total loading estimates for the Lavaca River watershed.
thanks: |
  This project was funded by a Texas Coastal Management Program grant approved by the Texas Land Commissioner, providing financial assistance under the Coastal Zone Management Act of 1972, as amended, awarded by the National Oceanic and Atmospheric Administration (NOAA), Office for Coastal Management, pursuant to NOAA Award No. NA21NOS4190136. The views expressed herein are those of the author(s) and do not necessarily reflect the views of NOAA, the U.S. Department of Commerce, or any of their subagencies.
format: 
  pdf:
    keep-md: true
    keep-tex: true
    documentclass: article
    mainfont: MINIONPRO-REGULAR.OTF
    sansfont: MORISTONPERSONAL-REGULAR.OTF
    number-sections: true
    fig-pos: 'h'
    execute:
      eval: true
      echo: false
      warning: false
      error: false
      message: false
    include-in-header:
      text: |
        \usepackage{flafter, amsmath, booktabs, caption, longtable, changepage, multirow}
        \newenvironment{widestuff}{\begin{table}[h]\begin{adjustwidth}{-4.5cm}{-4.5cm}\centering}{\end{adjustwidth}\end{table}}
knitr: 
  opts_chunk: 
    dev: ragg_png
    dpi: 200
    # flextable options
    ft.align: "center"
    ft.latex.float: "none"
    #ft.tabcolsep: 0
    tab.lp: "tbl-"
bibliography: reference.yml
csl: https://raw.githubusercontent.com/TxWRI/csl/main/twri-technical-report.csl
---
```{r}
#| label: setup
#| echo: false

library(targets)
library(dplyr)
library(ggplot2)
library(ggtext)
library(patchwork)
library(targets)
library(twriTemplates)
```


# Load estimation and summarization

Daily Nitrate-Nitrogen (NO~3~-N) and Total Phosphorus (TP) loads at stream sites were predicted using fitted GAM models. Standard deviations and credible intervals from GAM models can be obtained by drawing samples from the multivariate normal posterior distribution of the fitted GAM [@woodCONFIDENCEINTERVALSGENERALIZED2006; @marraCoveragePropertiesConfidence2012; @mcdowellImplicationsLagTimes2021]. Uncertainty in loads were reported as 95% credible intervals developed by drawing 1000 realizations of parameter estimates from the multivariate normal posterior distribution of the model parameters. We re-estimated the load for each realization and report the 2.5% and 97.5% quantiles. Monthly and annual loads were calculated by summing for each respective time period. 

Daily flow variability is responsible for the majority of daily load variability. WRTDS utilizes a flow- normalization procedure that removes the influence of flow variability by treating daily flow as a random sample of all possible discharges on a given day [@hirschWeightedRegressionsTime2010]. The flow-normalized estimates are not true estimates of load, but are indicative of potential changes in load that are not attributable to variability in daily flow. These flow-normalized estimates are most suitable for assessing changes in long-term trends. We implemented a similar procedure by setting flow-based covariates on each day of the year equal to each of the historical values for that day of the year between 2000 and 2021. The flow-normalized estimate is simply the mean of the model predictions for each day considering all of the flow values. Flow-normalized estimates and credible intervals were aggregated to annual reporting periods following procedures used for predicted actual loading.


# Total Load Estimates

## Lavaca River at Edna, USGS-08164000

```{r}
#| echo: false
#| label: no3_aggregate-08164000
#| fig-cap: "Aggregated (a) monthly and (b) annual NO~3~-N loads at Lavaca River at Edna, USGS-08164000."
#| fig-height: 6.5
#| fig-width: 5.5

load <- tar_read(daily_no3_08164000)
fn_load <- tar_read(daily_no3_08164000_fn)


montly_load <- load$monthly |> 
  mutate(x = as.Date(paste0(month, "-01"), "%Y-%m-%d"))

a <- ggplot() +
  geom_point(data = montly_load,
             aes(x, NO3_Estimate),
             color = "#1A3399") +
  geom_linerange(data = montly_load,
                 aes(x = x, ymin = NO3_Lower, ymax = NO3_Upper),
                 color = "#1A3399") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y-%m",
               limits = c(as.Date("2005-01-01"), as.Date("2020-12-31")),
               expand = c(0.025, 0.025)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Monthly NO<sub>3</sub>-N Load [kg]") +
  theme_TWRI_print() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"))

b <- ggplot() +
  geom_point(data = load$annually, aes(year, NO3_Estimate,
                                   color = "Total Annual Load",
                                   shape = "Total Annual Load")) +
  geom_line(data = load$annually, aes(x = year, y = NO3_Estimate,
                                  color = "Total Annual Load",
                                  linetype = "Total Annual Load"),
            alpha = 0.5) +
  geom_linerange(data = load$annually, aes(x = year, ymin = NO3_Lower, ymax = NO3_Upper,
                                       color = "Total Annual Load")) +
  geom_point(data = fn_load$annually, aes(year, NO3_Estimate,
                                 color = "Flow Normalized Annual Load",
                                 shape = "Flow Normalized Annual Load")) +
  geom_line(data = fn_load$annually,
            aes(x = year, y = NO3_Estimate,
                color = "Flow Normalized Annual Load",
                linetype = "Flow Normalized Annual Load"),
            alpha = 0.5) +
  # geom_linerange(data = fn_load,
  #                aes(x = year, ymin = NO3_Lower, ymax = NO3_Upper,
  #                    color = "Flow Normalized Annual Load")) +
  labs(x = "", y = "Annual NO<sub>3</sub>-N Load [kg]") +
  scale_shape_manual(name = "values",
                     values = c(21, 19)) +
  scale_color_manual(name = "values",
                     values = c("#7E1900", "#1A3399")) +
  scale_linetype_manual(name = "values",
                        values = c(1, 2)) +
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, 500000)) +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())

(a / b) + plot_annotation(tag_levels = "a")
```


```{r}
#| echo: false
#| label: tp_aggregate-08164000
#| fig-cap: "Aggregated (a) monthly and (b) annual TP loads at Lavaca River at Edna, USGS-08164000."
#| fig-height: 6.5
#| fig-width: 5.5


load <- tar_read(daily_tp_08164000)
fn_load <- tar_read(daily_tp_08164000_fn)


monthly_load <- load$monthly |>
  mutate(x = as.Date(paste0(month, "-01"), "%Y-%m-%d"))

a <- ggplot() +
  geom_point(data = monthly_load,
             aes(x, TP_Estimate),
                 color = "#1A3399") +
  geom_linerange(data = monthly_load,
                 aes(x = x, ymin = TP_Lower, ymax = TP_Upper),
                 color = "#1A3399") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y-%m",
               limits = c(as.Date("2000-01-01"), as.Date("2020-12-31")),
               expand = c(0.025, 0.025)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Monthly TP Load [kg]") +
  theme_TWRI_print() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"))


b <- ggplot() +
  geom_point(data = load$annually, aes(year, TP_Estimate,
                              color = "Total Annual Load",
                              shape = "Total Annual Load")) +
  geom_line(data = load$annually, aes(x = year, y = TP_Estimate,
                             color = "Total Annual Load",
                             linetype = "Total Annual Load"),
            alpha = 0.5) +
  geom_linerange(data = load$annually, aes(x = year, ymin = TP_Lower, ymax = TP_Upper,
                                  color = "Total Annual Load")) +
  geom_point(data = fn_load$annually, aes(year, TP_Estimate,
                                 color = "Flow Normalized Annual Load",
                                 shape = "Flow Normalized Annual Load")) +
  geom_line(data = fn_load$annually,
            aes(x = year, y = TP_Estimate,
                color = "Flow Normalized Annual Load",
                linetype = "Flow Normalized Annual Load"),
            alpha = 0.5) +
  labs(x = "", y = "Annual TP Load [kg]") +
  scale_shape_manual(name = "values",
                     values = c(21, 19)) +
  scale_color_manual(name = "values",
                     values = c("#7E1900", "#1A3399")) +
  scale_linetype_manual(name = "values",
                        values = c(1, 2)) +
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, 500000)) +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())

(a / b) + plot_annotation(tag_levels = "a")
```

\clearpage

## Navidad River at Palmetto Bend Dam, Lake Texana

```{r}
#| echo: false
#| label: no3_aggregate-texana
#| fig-cap: "Aggregated (a) monthly and (b) annual NO~3~-N loads at Palmetto Bend Dam at Lake Texana."
#| fig-height: 6
#| fig-width: 6


load <- tar_read(daily_no3_texana)
fn_load <- tar_read(daily_no3_texana_fn)

montly_load <- load$monthly |>
  mutate(x = as.Date(paste0(month, "-01"), "%Y-%m-%d"))

a <- ggplot() +
  geom_point(data = montly_load,
             aes(x, NO3_Estimate),
             color = "#1A3399") +
  geom_linerange(data = montly_load,
                 aes(x = x, ymin = NO3_Lower, ymax = NO3_Upper),
                 color = "#1A3399") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y-%m",
               limits = c(as.Date("2005-01-01"), as.Date("2020-12-31")),
               expand = c(0.025, 0.025)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Monthly NO<sub>3</sub>-N Load [kg]") +
  theme_TWRI_print() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"))

b <- ggplot() +
  geom_point(data = load$annually, aes(year, NO3_Estimate,
                                       color = "Total Annual Load",
                                       shape = "Total Annual Load")) +
  geom_line(data = load$annually, aes(x = year, y = NO3_Estimate,
                                      color = "Total Annual Load",
                                      linetype = "Total Annual Load"),
            alpha = 0.5) +
  geom_linerange(data = load$annually, aes(x = year, ymin = NO3_Lower, ymax = NO3_Upper,
                                           color = "Total Annual Load")) +
  geom_point(data = fn_load$annually, aes(year, NO3_Estimate,
                                          color = "Flow Normalized Annual Load",
                                          shape = "Flow Normalized Annual Load")) +
  geom_line(data = fn_load$annually,
            aes(x = year, y = NO3_Estimate,
                color = "Flow Normalized Annual Load",
                linetype = "Flow Normalized Annual Load"),
            alpha = 0.5) +
  # geom_linerange(data = fn_load,
  #                aes(x = year, ymin = NO3_Lower, ymax = NO3_Upper,
  #                    color = "Flow Normalized Annual Load")) +
  labs(x = "", y = "Annual NO<sub>3</sub>-N Load [kg]") +
  scale_shape_manual(name = "values",
                     values = c(21, 19)) +
  scale_color_manual(name = "values",
                     values = c("#7E1900", "#1A3399")) +
  scale_linetype_manual(name = "values",
                        values = c(1, 2)) +
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, 750000)) +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())

(a / b) + plot_annotation(tag_levels = "a")

```

```{r}
#| echo: false
#| label: tp_aggregate-texana
#| fig-cap: "Aggregated (a) monthly and (b) annual TP loads at Palmetto Bend Dam at Lake Texana."
#| fig-height: 6
#| fig-width: 6

load <- tar_read(daily_tp_texana)
fn_load <- tar_read(daily_tp_texana_fn)

montly_load <- load$monthly |>
  mutate(x = as.Date(paste0(month, "-01"), "%Y-%m-%d"))

a <- ggplot() +
  geom_point(data = monthly_load,
             aes(x, TP_Estimate),
                 color = "#1A3399") +
  geom_linerange(data = monthly_load,
                 aes(x = x, ymin = TP_Lower, ymax = TP_Upper),
                 color = "#1A3399") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y-%m",
               limits = c(as.Date("2000-01-01"), as.Date("2020-12-31")),
               expand = c(0.025, 0.025)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Monthly TP Load [kg]") +
  theme_TWRI_print() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"))


b <- ggplot() +
  geom_point(data = load$annually, aes(year, TP_Estimate,
                              color = "Total Annual Load",
                              shape = "Total Annual Load")) +
  geom_line(data = load$annually, aes(x = year, y = TP_Estimate,
                             color = "Total Annual Load",
                             linetype = "Total Annual Load"),
            alpha = 0.5) +
  geom_linerange(data = load$annually, aes(x = year, ymin = TP_Lower, ymax = TP_Upper,
                                  color = "Total Annual Load")) +
  geom_point(data = fn_load$annually, aes(year, TP_Estimate,
                                 color = "Flow Normalized Annual Load",
                                 shape = "Flow Normalized Annual Load")) +
  geom_line(data = fn_load$annually,
            aes(x = year, y = TP_Estimate,
                color = "Flow Normalized Annual Load",
                linetype = "Flow Normalized Annual Load"),
            alpha = 0.5) +
  labs(x = "", y = "Annual TP Load [kg]") +
  scale_shape_manual(name = "values",
                     values = c(21, 19)) +
  scale_color_manual(name = "values",
                     values = c("#7E1900", "#1A3399")) +
  scale_linetype_manual(name = "values",
                        values = c(1, 2)) +
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, 750000)) +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())

(a / b) + plot_annotation(tag_levels = "a")
```

\clearpage

## Total Export

### NO~3~-N

```{r}
#| echo: false
#| label: no3_total_export
#| fig-cap: "Modelled monthly and annual total NO~3~-N input to Lavaca Bay"
#| fig-height: 6
#| fig-width: 6
load_lav_no3 <- tar_read(daily_no3_08164000)
load_nav_no3 <- tar_read(daily_no3_texana)

load_lav_no3$monthly |> 
  mutate(site = "Lavaca River") -> lavaca_no3_monthly

load_nav_no3$monthly |> 
  mutate(site = "Navidad River") -> navidad_no3_monthly


no3_month <- bind_rows(lavaca_no3_monthly, navidad_no3_monthly) |> 
  mutate(x = as.Date(paste0(month, "-01"), "%Y-%m-%d"))


a <- ggplot(no3_month) +
  geom_col(aes(x, NO3_Estimate, fill = site)) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y",
               limits = c(as.Date("2005-01-01"), as.Date("2020-12-31")),
               expand = c(0.025, 0.025)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Monthly NO<sub>3</sub>-N Load [kg]") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())


load_lav_no3$annually |> 
  mutate(site = "Lavaca River") -> lavaca_no3_annually

load_nav_no3$annually |> 
  mutate(site = "Navidad River") -> navidad_no3_annually


no3_annual <- bind_rows(lavaca_no3_annually, navidad_no3_annually) |> 
  mutate(x = as.Date(paste0(year, "-01-01"), "%Y-%m-%d"))

b <- ggplot(no3_annual) +
  geom_col(aes(year, NO3_Estimate, fill = site), width = 1) +
  scale_x_continuous(expand = c(0.025, 0.025), breaks = c(2005:2021)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Annual NO<sub>3</sub>-N Load [kg]") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())
layout <- "
A
A
A
A
B
B
B
B
C
"


(a / b / guide_area()) + plot_annotation(tag_levels = "a") + plot_layout(guides = 'collect', design  = layout)


```

\clearpage

### TP

```{r}
#| echo: false
#| label: tp_total_export
#| fig-cap: "Modelled monthly and annual total TP input to Lavaca Bay"
#| fig-height: 6
#| fig-width: 6
load_lav_tp <- tar_read(daily_tp_08164000)
load_nav_tp <- tar_read(daily_tp_texana)

load_lav_tp$monthly |> 
  mutate(site = "Lavaca River") -> lavaca_tp_monthly

load_nav_tp$monthly |> 
  mutate(site = "Navidad River") -> navidad_tp_monthly


tp_month <- bind_rows(lavaca_tp_monthly, navidad_tp_monthly) |> 
  mutate(x = as.Date(paste0(month, "-01"), "%Y-%m-%d"))


a <- ggplot(tp_month) +
  geom_col(aes(x, TP_Estimate, fill = site)) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y",
               limits = c(as.Date("2000-01-01"), as.Date("2020-12-31")),
               expand = c(0.025, 0.025)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Monthly TP Load [kg]") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())


load_lav_tp$annually |> 
  mutate(site = "Lavaca River") -> lavaca_tp_annually

load_nav_tp$annually |> 
  mutate(site = "Navidad River") -> navidad_tp_annually


tp_annual <- bind_rows(lavaca_tp_annually, navidad_tp_annually) |> 
  mutate(x = as.Date(paste0(year, "-01-01"), "%Y-%m-%d"))

b <- ggplot(tp_annual) +
  geom_col(aes(year, TP_Estimate, fill = site), width = 1) +
  scale_x_continuous(expand = c(0.025, 0.025), breaks = c(2000:2021)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "", y = "Predicted Annual TP Load [kg]") +
  theme_TWRI_print() +
  theme(axis.title.y = element_markdown(),
        panel.grid.major.x = element_line(color = "#d9d9d9",
                                          linetype = "dotted"),
        legend.title = element_blank())
layout <- "
A
A
A
A
B
B
B
B
C
"


(a / b / guide_area()) + plot_annotation(tag_levels = "a") + plot_layout(guides = 'collect', design  = layout)


```


\clearpage

# References
